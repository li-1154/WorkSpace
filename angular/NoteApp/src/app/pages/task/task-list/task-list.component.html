<div class="attendance-container">

  <!-- üîπ Tabs -->
  <div class="tab-header">
    <div class="tab" 
         [class.active]="currentTab === 'personal'" 
         (click)="currentTab = 'personal'">üë§ ‰∏™‰∫∫</div>

    <div class="tab" 
         [class.active]="currentTab === 'group'" 
         (click)="currentTab = 'group'">üë• ÁªÑÂëò</div>
  </div>


  <!-- ================= PERSONAL ================= -->
  <div *ngIf="currentTab === 'personal'">

    <!-- Header -->
    <div class="header-bar">
      <div class="header-flex">
        <div class="header-left">
          <span class="date">{{ todayStr }}</span>
          <span class="time">{{ currentTime }}</span>
        </div>
        <button (click)="toggleAddTask()" class="add-btn">
          <img src="assets/icon/add.svg" width="18" />
        </button>
      </div>
      <div class="quote-line">{{ quote }}</div>
    </div>


    <!-- Add form -->
    <app-task-form *ngIf="showAddTask"
      (save)="addTask($event)"
      (cancel)="toggleAddTask()">
    </app-task-form>


    <!-- üìÖ ‰ªäÊó•‰∫ãÈ°π -->
    <div class="section">
      <div class="section-title" (click)="toggleCollapse('today')">
        üìÖ ‰ªäÊó•‰∫ãÈ°π
        <i [ngClass]="collapsed.today ? 'fas fa-angle-down' : 'fas fa-angle-up'"></i>
      </div>

      <div *ngIf="!collapsed.today">

        <div *ngFor="let t of todayTasks$ | async"
             class="task-card"
             [ngClass]="priorityClass(t.priority)"
             (click)="selectTask(t)">

          <div class="task-content">

            <div class="checkbox"
                 [class.checked]="t.done"
                 (click)="toggleDone(t,$event)">
            </div>

            <!-- ÈªòËÆ§ÊòæÁ§∫ -->
            <ng-container *ngIf="!t.editing">
              <div class="text-block">
                <div class="task-title" [class.done]="t.done">{{ t.name }}</div>
                <div class="task-date">{{ formatDate(t) }}</div>
              </div>
            </ng-container>

            <!-- ÁºñËæë -->
            <ng-container *ngIf="t.editing">
              <div class="edit-block">
                <input type="text" [(ngModel)]="t.name">
                <div class="row-time">
                  <input type="time" [(ngModel)]="t.startTime">
                  <span>~</span>
                  <input type="time" [(ngModel)]="t.endTime">
                </div>
                <select [(ngModel)]="t.priority">
                  <option value="ÈáçË¶Å">ÈáçË¶Å</option>
                  <option value="Á¥ßÊÄ•">Á¥ßÊÄ•</option>
                  <option value="‰∏çÈáçË¶Å„Éª‰∏çÁ¥ßÊÄ•">‰∏çÈáçË¶Å„Éª‰∏çÁ¥ßÊÄ•</option>
                </select>
              </div>
            </ng-container>

            <div class="priority-wrapper" *ngIf="!t.editing">
              <span class="priority-badge" [ngClass]="priorityClass(t.priority)">
                {{ t.priority }}
              </span>
            </div>

          </div>


          <!-- ‰ªÖÊú™ÂÆåÊàêÊó∂ÂèØÁºñËæë -->
          <div class="task-actions" *ngIf="t.showActions && !t.done">
            <button *ngIf="!t.editing" class="icon-btn" (click)="startEdit(t,$event)">‚úèÔ∏è</button>
            <button *ngIf="t.editing" class="icon-btn" (click)="saveEdit(t,$event)">‚úî</button>
            <button *ngIf="t.editing" class="icon-btn delete" (click)="cancelEdit(t,$event)">‚úñ</button>
            <button *ngIf="!t.editing" class="icon-btn delete" (click)="deleteTask(t,$event)">üóëÔ∏è</button>
          </div>

        </div>
      </div>
    </div>



    <!-- ‚è∞ Êú™ÂÆåÊàê‰ªªÂä°ÔºàÁé∞Âú®ÂÖÅËÆ∏ÁºñËæë ‚úîÔºâ -->
    <div class="section">
      <div class="section-title" (click)="toggleCollapse('overdue')">
        ‚è∞ Êú™ÂÆåÊàê‰ªªÂä°
        <i [ngClass]="collapsed.overdue ? 'fas fa-angle-down' : 'fas fa-angle-up'"></i>
      </div>

      <div *ngIf="!collapsed.overdue">

        <div *ngFor="let t of noDoneTasks$ | async"
             class="task-card"
             [ngClass]="priorityClass(t.priority)"
             (click)="selectTask(t)">

          <div class="task-content">
            <div class="checkbox" (click)="toggleDone(t,$event)"></div>

            <ng-container *ngIf="!t.editing">
              <div class="text-block">
                <div class="task-title">{{ t.name }}</div>
                <div class="task-date">{{ formatDate(t) }}</div>
              </div>
            </ng-container>

            <ng-container *ngIf="t.editing">
              <div class="edit-block">
                <input type="text" [(ngModel)]="t.name">
                <div class="row-time">
                  <input type="time" [(ngModel)]="t.startTime">
                  <span>~</span>
                  <input type="time" [(ngModel)]="t.endTime">
                </div>
                <select [(ngModel)]="t.priority">
                  <option value="ÈáçË¶Å">ÈáçË¶Å</option>
                  <option value="Á¥ßÊÄ•">Á¥ßÊÄ•</option>
                  <option value="‰∏çÈáçË¶Å„Éª‰∏çÁ¥ßÊÄ•">‰∏çÈáçË¶Å„Éª‰∏çÁ¥ßÊÄ•</option>
                </select>
              </div>
            </ng-container>

            <div class="priority-wrapper" *ngIf="!t.editing">
              <span class="priority-badge" [ngClass]="priorityClass(t.priority)">
                {{ t.priority }}
              </span>
            </div>
          </div>

          <div class="task-actions" *ngIf="t.showActions">
            <button *ngIf="!t.editing" class="icon-btn" (click)="startEdit(t,$event)">‚úèÔ∏è</button>
            <button *ngIf="t.editing" class="icon-btn" (click)="saveEdit(t,$event)">‚úî</button>
            <button *ngIf="t.editing" class="icon-btn delete" (click)="cancelEdit(t,$event)">‚úñ</button>
            <button *ngIf="!t.editing" class="icon-btn delete" (click)="deleteTask(t,$event)">üóëÔ∏è</button>
          </div>

        </div>
      </div>
    </div>



    <!-- ‚òë Â∑≤ÂÆåÊàê‰ªªÂä°Ôºà‰∏çÂèØÁºñËæëÔºâ -->
    <div class="section">
      <div class="section-title" (click)="toggleCollapse('done')">
        ‚òë Â∑≤ÂÆåÊàê‰ªªÂä°
        <i [ngClass]="collapsed.done ? 'fas fa-angle-down' : 'fas fa-angle-up'"></i>
      </div>

      <div *ngIf="!collapsed.done">

        <div *ngFor="let t of doneTasks$ | async"
             class="task-card done">

          <div class="task-content">
            <div class="checkbox checked" (click)="toggleDone(t,$event)"></div>

            <div class="text-block">
              <div class="task-title done">{{ t.name }}</div>
              <div class="task-date">{{ formatDate(t) }}</div>
            </div>

            <div class="priority-wrapper">
              <span class="priority-badge" [ngClass]="priorityClass(t.priority)">
                {{ t.priority }}
              </span>
            </div>
          </div>

        </div>
      </div>
    </div>

  </div>



  <!-- ================= GROUP ================= -->
  <div *ngIf="currentTab === 'group'">

    <div class="header-bar">
      <div class="header-row">
        <span class="date">{{ todayStr }}</span>
        <span class="time">{{ currentTime }}</span>
      </div>
    </div>

    <ng-container *ngFor="let blk of [
      {title:'üìÖ ‰ªäÊó•ÂÖ±‰∫´‰ªªÂä°', key:'teamToday', list:teamTodayTasks$},
      {title:'‚è∞ Êú™ÂÆåÊàêÂÖ±‰∫´‰ªªÂä°', key:'teamNoDone', list:teamNoDoneTasks$},
      {title:'‚úî Â∑≤ÂÆåÊàêÂÖ±‰∫´‰ªªÂä°', key:'teamDone', list:teamDoneTasks$}
    ]">

      <div class="section">
        <div class="section-title" (click)="toggleCollapse(blk.key)">
          {{ blk.title }}
          <i [ngClass]="collapsed[blk.key] ? 'fas fa-angle-down' : 'fas fa-angle-up'"></i>
        </div>

        <div *ngIf="!collapsed[blk.key]">
          <div *ngFor="let t of blk.list | async"
               class="task-card"
               [ngClass]="priorityClass(t.priority)">

            <div class="task-content">
              <div class="checkbox" [class.checked]="t.done" (click)="toggleDone(t,$event)"></div>

              <div class="text-block">
                <div class="task-title">{{ t.name }}</div>
                <div class="task-date">{{ formatDate(t) }}</div>
              </div>

              <div class="priority-wrapper">
                <span class="priority-badge" [ngClass]="priorityClass(t.priority)">
                  {{ t.priority }}
                </span>
              </div>
            </div>

          </div>
        </div>
      </div>

    </ng-container>
  </div>

</div>
